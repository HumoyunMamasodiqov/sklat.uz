<!DOCTYPE html>
<html lang="uz">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sklat.uz - Analitika</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'img/sklatlogo.png' %}">
    <link rel="apple-touch-icon" sizes="512x512" href="{% static 'img/sklatlogo.png' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- CSS va JavaScript kutubxonalari -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    
    <!-- Fontlar va ikonlar -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    
    <!-- ECharts kutubxonasi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Animatsiyalar */
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 200px;
        }
        
        .small-chart {
            position: relative;
            height: 120px;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Xabarlar -->
    {% if messages %}
    <div class="fixed top-16 left-4 right-4 z-50 space-y-2">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} bg-{% if message.tags == 'success' %}green{% elif message.tags == 'error' %}red{% elif message.tags == 'warning' %}orange{% else %}blue{% endif %}-500 text-white p-3 rounded-lg shadow-lg slide-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="ri-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}error-warning{% elif message.tags == 'warning' %}alert{% else %}information{% endif %}-line"></i>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
                <button class="close-message text-white hover:text-gray-200">
                    <i class="ri-close-line"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Header -->
    <header class="fixed top-0 w-full bg-white shadow-sm z-40">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center space-x-3">
                <a href="{% url 'home' %}" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors">
                    <i class="ri-arrow-left-line text-gray-600"></i>
                </a>
                <h1 class="text-lg font-semibold text-gray-800">Analitika</h1>
            </div>
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <button class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors" id="filter-btn">
                        <i class="ri-filter-3-line text-gray-600"></i>
                    </button>
                    <div class="absolute right-0 top-10 bg-white shadow-lg rounded-lg p-2 w-48 hidden" id="filter-menu">
                        <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2" data-period="today">
                            <i class="ri-calendar-line text-gray-400"></i>
                            <span>Bugungi</span>
                        </button>
                        <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2" data-period="week">
                            <i class="ri-calendar-event-line text-gray-400"></i>
                            <span>Bu hafta</span>
                        </button>
                        <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2" data-period="month">
                            <i class="ri-calendar-2-line text-gray-400"></i>
                            <span>Bu oy</span>
                        </button>
                        <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2" data-period="year">
                            <i class="ri-calendar-schedule-line text-gray-400"></i>
                            <span>Bu yil</span>
                        </button>
                    </div>
                </div>
                <button class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors" id="settings-btn" onclick="showAnalyticsSettings()">
                    <i class="ri-settings-3-line text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Stats Cards -->
    <section class="pt-20 px-4 pb-4">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="ri-money-dollar-circle-line text-blue-600"></i>
                    </div>
                    <div class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">
                        +{{ total_sales_month|default:"0"|floatformat:1 }}%
                    </div>
                </div>
                <div class="text-xl font-bold text-gray-800">{{ total_sales_month|default:0|floatformat:0 }}</div>
                <div class="text-xs text-gray-500">Oylik daromad (so'm)</div>
            </div>
            
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="ri-line-chart-line text-green-600"></i>
                    </div>
                    <div class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">
                        {{ active_customers|default:0 }}/{{ total_customers|default:0 }}
                    </div>
                </div>
                <div class="text-xl font-bold text-gray-800">{{ avg_purchase|default:0|floatformat:0 }}</div>
                <div class="text-xs text-gray-500">O'rtacha xarid (so'm)</div>
            </div>
            
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="ri-trophy-line text-purple-600"></i>
                    </div>
                    <div class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">
                        TOP
                    </div>
                </div>
                <div class="text-sm font-bold text-gray-800 truncate">
                    {% if top_products.0 %}
                        {{ top_products.0.name }}
                    {% else %}
                        Ma'lumot yo'q
                    {% endif %}
                </div>
                <div class="text-xs text-gray-500">Eng ko'p sotiladigan</div>
            </div>
            
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="ri-user-3-line text-orange-600"></i>
                    </div>
                    <div class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">
                        +{{ new_customers_this_month|default:0 }}
                    </div>
                </div>
                <div class="text-xl font-bold text-gray-800">{{ active_customers|default:0 }}</div>
                <div class="text-xs text-gray-500">Faol mijozlar</div>
            </div>
        </div>
    </section>
    
    <!-- Time Filter -->
    <section class="px-4 pb-4">
        <div class="bg-gray-100 p-1 rounded-lg flex space-x-1" id="time-filter">
            <button class="flex-1 px-1 py-1 {% if period == 'day' %}bg-white text-primary{% else %}text-gray-600{% endif %} rounded text-sm font-medium cursor-pointer !rounded-button time-btn" 
                    data-period="day" onclick="changePeriod('day')">
                Kunlik
            </button>
            <button class="flex-1 px-1 py-1 {% if period == 'week' %}bg-white text-primary{% else %}text-gray-600{% endif %} rounded text-sm font-medium cursor-pointer !rounded-button time-btn" 
                    data-period="week" onclick="changePeriod('week')">
                Haftalik
            </button>
            <button class="flex-1 px-1 py-1 {% if period == 'month' %}bg-white text-primary{% else %}text-gray-600{% endif %} rounded text-sm font-medium cursor-pointer !rounded-button time-btn" 
                    data-period="month" onclick="changePeriod('month')">
                Oylik
            </button>
            <button class="flex-1 px-1 py-1 {% if period == 'year' %}bg-white text-primary{% else %}text-gray-600{% endif %} rounded text-sm font-medium cursor-pointer !rounded-button time-btn" 
                    data-period="year" onclick="changePeriod('year')">
                Yillik
            </button>
        </div>
    </section>
    
    <!-- Sales Chart -->
    <section class="px-4 pb-4">
        <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-semibold text-gray-800">Sotuv dinamikasi</h3>
                <a href="#" class="text-xs text-primary cursor-pointer hover:underline">Batafsil</a>
            </div>
            <div id="sales-chart" class="chart-container"></div>
        </div>
    </section>
    
    <!-- Top Products -->
    <section class="px-4 pb-4">
        <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-semibold text-gray-800">Eng ko'p sotiladigan mahsulotlar</h3>
                <a href="{% url 'mahsulotlar' %}" class="text-xs text-primary cursor-pointer hover:underline">Barchasini ko'rish</a>
            </div>
            
            <div class="space-y-3">
                {% if top_products %}
                    {% for product in top_products %}
                    <div class="flex items-center space-x-3 hover:bg-gray-50 p-2 rounded-lg transition-colors">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center bg-gray-200">
                                    <i class="ri-shopping-bag-3-line text-gray-400 text-lg"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <div class="pr-2">
                                    <h4 class="text-sm font-medium text-gray-800 truncate">{{ product.name }}</h4>
                                    <p class="text-xs text-gray-500">
                                        {% if product.total_sold %}
                                            {{ product.total_sold|floatformat:0 }} {{ product.unit }} sotildi
                                        {% else %}
                                            {{ product.quantity|floatformat:0 }} {{ product.unit }} mavjud
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-gray-800">
                                        {% if product.total_revenue %}
                                            {{ product.total_revenue|floatformat:0 }} so'm
                                        {% else %}
                                            {{ product.sale_price|floatformat:0 }} so'm
                                        {% endif %}
                                    </div>
                                    <div class="text-xs {% if product.total_sold and product.total_sold > 0 %}text-green-600{% else %}text-gray-500{% endif %}">
                                        {% if product.profit_margin %}
                                            {{ product.profit_margin|floatformat:1 }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-bar-chart-2-line text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-gray-500 text-sm">Sotuv ma'lumotlari mavjud emas</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
    
    <!-- Additional Analytics -->
    <section class="px-4 pb-4">
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">Kategoriyalar bo'yicha</h3>
                <div id="category-chart" class="small-chart"></div>
            </div>
            
            <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">Faol soatlar</h3>
                <div class="space-y-2">
                    {% with hour_ranges="10:00-12:00,14:00-16:00,18:00-20:00,08:00-10:00"|split:"," %}
                    {% for hour_range in hour_ranges %}
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">{{ hour_range }}</span>
                        <div class="flex items-center space-x-2">
                            {% with widths="8,6,4,3"|split:"," percentages="35%,28%,22%,15%"|split:"," colors="primary,secondary,orange-400,purple-400"|split:"," %}
                            <div class="w-{{ widths.forloop.counter0 }} bg-{{ colors.forloop.counter0 }} h-1 rounded-full"></div>
                            <span class="text-xs font-medium text-gray-800">{{ percentages.forloop.counter0 }}</span>
                            {% endwith %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </section>
    
    <!-- Quick Actions -->
    <section class="px-4 pb-24">
        <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
            <h3 class="text-base font-semibold text-gray-800 mb-4">Tezkor amallar</h3>
            <div class="grid grid-cols-3 gap-3">
                <button class="flex flex-col items-center space-y-2 p-3 bg-blue-50 rounded-lg cursor-pointer !rounded-button hover:bg-blue-100 transition-colors" onclick="exportReport()" id="export-report">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="ri-download-2-line text-blue-600"></i>
                    </div>
                    <span class="text-xs text-blue-600 font-medium text-center">Hisobot export</span>
                </button>
                
                <button class="flex flex-col items-center space-y-2 p-3 bg-green-50 rounded-lg cursor-pointer !rounded-button hover:bg-green-100 transition-colors" onclick="refreshData()" id="refresh-data">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="ri-refresh-line text-green-600"></i>
                    </div>
                    <span class="text-xs text-green-600 font-medium text-center">Ma'lumot yangilash</span>
                </button>
                
                <button class="flex flex-col items-center space-y-2 p-3 bg-purple-50 rounded-lg cursor-pointer !rounded-button hover:bg-purple-100 transition-colors" onclick="showDetailedReport()" id="detailed-report">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="ri-file-chart-line text-purple-600"></i>
                    </div>
                    <span class="text-xs text-purple-600 font-medium text-center">Batafsil hisobot</span>
                </button>
            </div>
        </div>
    </section>
    
    <!-- FAB Button -->
    <button class="fixed bottom-20 right-4 w-14 h-14 bg-primary rounded-full shadow-lg flex items-center justify-center cursor-pointer !rounded-button z-40 hover:bg-blue-600 transition-colors hover:scale-105 transform" onclick="showQuickAnalytics()">
        <i class="ri-bar-chart-2-fill text-white text-2xl"></i>
    </button>
    
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-30">
        <div class="grid grid-cols-5 h-16">
            <a href="{% url 'home' %}" class="flex flex-col items-center justify-center space-y-1 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-home-5-line text-gray-400"></i>
                </div>
                <span class="text-xs text-gray-400">Bosh sahifa</span>
            </a>
            
            <a href="{% url 'mahsulotlar' %}" class="flex flex-col items-center justify-center space-y-1 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-shopping-bag-3-line text-gray-400"></i>
                </div>
                <span class="text-xs text-gray-400">Mahsulotlar</span>
            </a>
            
            <button class="flex flex-col items-center justify-center space-y-1 cursor-pointer active-nav">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-bar-chart-box-fill text-primary"></i>
                </div>
                <span class="text-xs text-primary font-medium">Analitika</span>
            </button>
            
            <a href="{% url 'mijozlar' %}" class="flex flex-col items-center justify-center space-y-1 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-group-line text-gray-400"></i>
                </div>
                <span class="text-xs text-gray-400">Mijozlar</span>
            </a>
            
            <a href="{% url 'sozlamalar' %}" class="flex flex-col items-center justify-center space-y-1 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-settings-3-line text-gray-400"></i>
                </div>
                <span class="text-xs text-gray-400">Sozlamalar</span>
            </a>
        </div>
    </nav>
    
    <!-- Settings Modal Template -->
    <div id="settings-modal-template" class="hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
            <div class="bg-white w-full rounded-t-2xl p-6 slide-in">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Analitika sozlamalari</h3>
                    <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center cursor-pointer close-modal hover:bg-gray-200 transition-colors">
                        <i class="ri-close-line text-gray-600"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chastota yangilash</label>
                        <select class="w-full px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent focus:outline-none text-sm">
                            <option value="5">Har 5 daqiqa</option>
                            <option value="15">Har 15 daqiqa</option>
                            <option value="30">Har 30 daqiqa</option>
                            <option value="60">Har soat</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chastota yangilash</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="custom-checkbox" checked>
                                <div class="checkbox-icon w-4 h-4 bg-primary rounded border-2 border-primary flex items-center justify-center">
                                    <i class="ri-check-line text-white text-xs"></i>
                                </div>
                                <span class="text-sm text-gray-700">Real vaqtli yangilash</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="custom-checkbox" checked>
                                <div class="checkbox-icon w-4 h-4 bg-primary rounded border-2 border-primary flex items-center justify-center">
                                    <i class="ri-check-line text-white text-xs"></i>
                                </div>
                                <span class="text-sm text-gray-700">Ogohlantirish xabarlari</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="custom-checkbox">
                                <div class="checkbox-icon w-4 h-4 bg-white rounded border-2 border-gray-300 flex items-center justify-center">
                                    <i class="ri-check-line text-white text-xs"></i>
                                </div>
                                <span class="text-sm text-gray-700">Qiyin grafikalar</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium cursor-pointer !rounded-button close-modal hover:bg-gray-200 transition-colors">Bekor qilish</button>
                        <button class="flex-1 bg-primary text-white py-3 rounded-lg font-medium cursor-pointer !rounded-button save-settings hover:bg-blue-600 transition-colors">Saqlash</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Global variables
        let salesChart, categoryChart;
        let currentPeriod = "{{ period|default:'day' }}";
        let isAutoRefresh = true;
        let refreshInterval = 30000; // 30 seconds
        
        // DOM yuklanganda
        document.addEventListener('DOMContentLoaded', function() {
            // Close message buttons
            const closeMessageButtons = document.querySelectorAll('.close-message');
            closeMessageButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const alert = this.closest('.alert');
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                });
            });
            
            // Auto-hide messages after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                });
            }, 5000);
            
            // Filter menu toggle
            const filterBtn = document.getElementById('filter-btn');
            const filterMenu = document.getElementById('filter-menu');
            
            if (filterBtn && filterMenu) {
                filterBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    filterMenu.classList.toggle('hidden');
                });
                
                document.addEventListener('click', function(e) {
                    if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target)) {
                        filterMenu.classList.add('hidden');
                    }
                });
                
                // Filter options
                const filterOptions = filterMenu.querySelectorAll('button[data-period]');
                filterOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const period = this.dataset.period;
                        changePeriod(period);
                        filterMenu.classList.add('hidden');
                    });
                });
            }
            
            // Initialize charts
            initCharts();
            
            // Auto refresh data
            if (isAutoRefresh) {
                startAutoRefresh();
            }
            
            // Load initial data from backend
            loadAnalyticsData();
        });
        
        // Initialize ECharts
        function initCharts() {
            salesChart = echarts.init(document.getElementById('sales-chart'));
            categoryChart = echarts.init(document.getElementById('category-chart'));
            
            // Set initial chart options
            updateCharts();
            
            // Handle window resize
            window.addEventListener('resize', function() {
                salesChart.resize();
                categoryChart.resize();
            });
        }
        
        // Update charts with data
        function updateCharts() {
            // Parse JSON data from Django template
            const salesLabels = JSON.parse('{{ sales_labels|safe }}');
            const salesData = JSON.parse('{{ sales_data|safe }}');
            const categoryData = JSON.parse('{{ category_data|safe }}');
            
            // Sales chart options
            const salesChartOptions = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = `<div class="text-sm font-medium">${params[0].axisValue}</div>`;
                        params.forEach(param => {
                            const value = new Intl.NumberFormat('uz-UZ').format(param.value);
                            result += `<div class="text-xs mt-1">${value} so'm</div>`;
                        });
                        return result;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: salesLabels,
                    axisLine: { 
                        show: false 
                    },
                    axisTick: { 
                        show: false 
                    },
                    axisLabel: { 
                        fontSize: 10, 
                        color: '#6B7280',
                        formatter: function(value) {
                            // Qisqartirish kerak bo'lsa
                            if (value.length > 5) {
                                return value.substring(0, 5) + '...';
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { 
                        fontSize: 10, 
                        color: '#6B7280',
                        formatter: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return value;
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#E5E7EB',
                            type: 'dashed'
                        }
                    }
                },
                grid: {
                    left: 40,
                    right: 20,
                    top: 30,
                    bottom: 30
                },
                series: [{
                    data: salesData,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    lineStyle: {
                        color: '#3B82F6',
                        width: 3
                    },
                    itemStyle: {
                        color: '#3B82F6',
                        borderColor: '#ffffff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                            ]
                        }
                    }
                }]
            };
            
            // Category chart options
            const categoryChartOptions = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `<div class="font-medium">${params.name}</div>
                                <div class="text-sm">${params.value}%</div>
                                <div class="text-xs text-gray-500">${(params.percent || 0).toFixed(1)}% umumiy sotuvdan</div>`;
                    }
                },
                legend: {
                    show: false
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 4,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    },
                    label: {
                        show: false
                    },
                    emphasis: {
                        scale: false,
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    data: categoryData.map(cat => ({
                        name: cat.name,
                        value: cat.amount > 0 ? cat.amount : 0,
                        itemStyle: {
                            color: getCategoryColor(cat.name)
                        }
                    }))
                }]
            };
            
            // Set chart options
            salesChart.setOption(salesChartOptions);
            categoryChart.setOption(categoryChartOptions);
        }
        
        // Get color for category
        function getCategoryColor(categoryName) {
            const colorMap = {
                'Oziq-ovqat': '#3B82F6',
                'Meva-sabzavot': '#10B981',
                'Ichimliklar': '#F59E0B',
                'Sut mahsulotlari': '#8B5CF6',
                'Maishiy': '#EC4899',
                'Boshqa': '#6B7280'
            };
            
            return colorMap[categoryName] || '#9CA3AF';
        }
        
        // Change period
        function changePeriod(period) {
            currentPeriod = period;
            
            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('bg-white', 'text-primary');
                    btn.classList.remove('text-gray-600');
                } else {
                    btn.classList.remove('bg-white', 'text-primary');
                    btn.classList.add('text-gray-600');
                }
            });
            
            // Reload data for new period
            loadAnalyticsData();
        }
        
        // Load analytics data from backend
        function loadAnalyticsData() {
            showLoading();
            
            fetch(`/analitika/?period=${currentPeriod}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response and update necessary parts
                // This is a simplified version - you might want to implement a more sophisticated approach
                hideLoading();
                
                // Show success notification
                showNotification('Ma\'lumotlar yangilandi!', 'success');
            })
            .catch(error => {
                console.error('Error loading analytics data:', error);
                hideLoading();
                showNotification('Ma\'lumotlarni yuklashda xatolik!', 'error');
            });
        }
        
        // Export report
        function exportReport() {
            showNotification('Hisobot export qilinmoqda...', 'info');
            
            // Simulate export process
            setTimeout(() => {
                showNotification('Hisobot muvaffaqiyatli export qilindi!', 'success');
                
                // Create download link
                const link = document.createElement('a');
                link.href = `/api/export-report/?period=${currentPeriod}`;
                link.download = `analitika-hisobot-${currentPeriod}-${new Date().toISOString().split('T')[0]}.pdf`;
                link.click();
            }, 2000);
        }
        
        // Refresh data
        function refreshData() {
            loadAnalyticsData();
        }
        
        // Show detailed report
        function showDetailedReport() {
            const modalDiv = document.createElement('div');
            modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end';
            modalDiv.innerHTML = `
                <div class="bg-white w-full rounded-t-2xl p-6 slide-in">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Batafsil hisobot</h3>
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center cursor-pointer close-modal hover:bg-gray-200 transition-colors">
                            <i class="ri-close-line text-gray-600"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Jami sotuv</div>
                                <div class="text-xl font-bold text-gray-800">{{ total_sales_month|default:0|floatformat:0 }} so'm</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">O'rtacha foyda</div>
                                <div class="text-xl font-bold text-green-600">
                                    {% if avg_purchase %}{{ avg_purchase|floatformat:0 }}{% else %}0{% endif %} so'm
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Eng yaxshi soatlar</div>
                            <div class="text-base font-medium text-gray-800">10:00 - 12:00 (35% sotuv)</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Eng ko'p sotilgan kategoriya</div>
                            <div class="text-base font-medium text-gray-800">Oziq-ovqat (35%)</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button class="bg-blue-50 text-blue-600 py-3 rounded-lg font-medium cursor-pointer !rounded-button hover:bg-blue-100 transition-colors" onclick="downloadReport('pdf')">
                                <i class="ri-file-pdf-line mr-2"></i>PDF
                            </button>
                            <button class="bg-green-50 text-green-600 py-3 rounded-lg font-medium cursor-pointer !rounded-button hover:bg-green-100 transition-colors" onclick="downloadReport('excel')">
                                <i class="ri-file-excel-line mr-2"></i>Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalDiv);
            
            const closeButton = modalDiv.querySelector('.close-modal');
            closeButton.addEventListener('click', function() {
                document.body.removeChild(modalDiv);
            });
            
            modalDiv.addEventListener('click', function(e) {
                if (e.target === modalDiv) {
                    document.body.removeChild(modalDiv);
                }
            });
        }
        
        // Show analytics settings
        function showAnalyticsSettings() {
            const template = document.getElementById('settings-modal-template');
            const modalHTML = template.innerHTML;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            modalDiv.id = 'analytics-settings-modal';
            
            document.body.appendChild(modalDiv);
            
            // Event listeners
            const closeButtons = modalDiv.querySelectorAll('.close-modal');
            const saveButton = modalDiv.querySelector('.save-settings');
            const checkboxes = modalDiv.querySelectorAll('.custom-checkbox');
            
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    document.body.removeChild(modalDiv);
                });
            });
            
            saveButton.addEventListener('click', function() {
                document.body.removeChild(modalDiv);
                showNotification('Sozlamalar saqlandi!', 'success');
            });
            
            // Checkbox handlers
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const icon = this.nextElementSibling;
                    if (this.checked) {
                        icon.classList.add('bg-primary', 'border-primary');
                        icon.querySelector('i').classList.remove('text-white');
                    } else {
                        icon.classList.remove('bg-primary', 'border-primary');
                        icon.querySelector('i').classList.add('text-white');
                    }
                });
            });
            
            modalDiv.addEventListener('click', function(e) {
                if (e.target === modalDiv) {
                    document.body.removeChild(modalDiv);
                }
            });
        }
        
        // Show quick analytics menu
        function showQuickAnalytics() {
            const quickMenu = document.createElement('div');
            quickMenu.className = 'fixed bottom-24 right-4 bg-white rounded-xl shadow-lg p-2 w-48 z-40 slide-in';
            quickMenu.innerHTML = `
                <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2 quick-action" data-action="today">
                    <i class="ri-calendar-line text-blue-600"></i>
                    <span>Bugungi hisobot</span>
                </button>
                <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2 quick-action" data-action="week">
                    <i class="ri-calendar-event-line text-green-600"></i>
                    <span>Haftalik hisobot</span>
                </button>
                <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2 quick-action" data-action="month">
                    <i class="ri-calendar-2-line text-purple-600"></i>
                    <span>Oylik hisobot</span>
                </button>
                <hr class="my-1">
                <button class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center space-x-2 quick-action" data-action="custom">
                    <i class="ri-settings-3-line text-orange-600"></i>
                    <span>Maxsus hisobot</span>
                </button>
            `;
            
            document.body.appendChild(quickMenu);
            
            // Remove on click outside
            setTimeout(() => {
                const removeMenu = (e) => {
                    if (!quickMenu.contains(e.target) && e.target.id !== 'fab-button') {
                        document.body.removeChild(quickMenu);
                        document.removeEventListener('click', removeMenu);
                    }
                };
                document.addEventListener('click', removeMenu);
            }, 100);
            
            // Action handlers
            const actionButtons = quickMenu.querySelectorAll('.quick-action');
            actionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.dataset.action;
                    
                    switch(action) {
                        case 'today':
                            changePeriod('day');
                            break;
                        case 'week':
                            changePeriod('week');
                            break;
                        case 'month':
                            changePeriod('month');
                            break;
                        case 'custom':
                            showCustomReportModal();
                            break;
                    }
                    
                    document.body.removeChild(quickMenu);
                });
            });
        }
        
        // Show custom report modal
        function showCustomReportModal() {
            const modalDiv = document.createElement('div');
            modalDiv.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end';
            modalDiv.innerHTML = `
                <div class="bg-white w-full rounded-t-2xl p-6 slide-in">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Maxsus hisobot</h3>
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center cursor-pointer close-modal hover:bg-gray-200 transition-colors">
                            <i class="ri-close-line text-gray-600"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Boshlanish sanasi</label>
                            <input type="date" class="w-full px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent focus:outline-none text-sm" id="start-date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tugash sanasi</label>
                            <input type="date" class="w-full px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent focus:outline-none text-sm" id="end-date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hisobot turi</label>
                            <select class="w-full px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent focus:outline-none text-sm" id="report-type">
                                <option value="sales">Sotuv hisoboti</option>
                                <option value="profit">Foyda hisoboti</option>
                                <option value="inventory">Ombor hisoboti</option>
                                <option value="customers">Mijozlar hisoboti</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 pt-4">
                            <button class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium cursor-pointer !rounded-button close-modal hover:bg-gray-200 transition-colors">Bekor qilish</button>
                            <button class="flex-1 bg-primary text-white py-3 rounded-lg font-medium cursor-pointer !rounded-button generate-report hover:bg-blue-600 transition-colors">Yaratish</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalDiv);
            
            // Set default dates
            const startDate = modalDiv.querySelector('#start-date');
            const endDate = modalDiv.querySelector('#end-date');
            const today = new Date().toISOString().split('T')[0];
            const lastWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            startDate.value = lastWeek;
            endDate.value = today;
            
            const closeButton = modalDiv.querySelector('.close-modal');
            const generateButton = modalDiv.querySelector('.generate-report');
            
            closeButton.addEventListener('click', function() {
                document.body.removeChild(modalDiv);
            });
            
            generateButton.addEventListener('click', function() {
                const start = startDate.value;
                const end = endDate.value;
                const type = modalDiv.querySelector('#report-type').value;
                
                if (!start || !end) {
                    showNotification('Iltimos, sanalarni kiriting!', 'error');
                    return;
                }
                
                document.body.removeChild(modalDiv);
                showNotification('Hisobot yaratilmoqda...', 'info');
                
                // Generate report
                setTimeout(() => {
                    showNotification('Hisobot yaratildi!', 'success');
                    downloadReport('pdf', start, end, type);
                }, 3000);
            });
            
            modalDiv.addEventListener('click', function(e) {
                if (e.target === modalDiv) {
                    document.body.removeChild(modalDiv);
                }
            });
        }
        
        // Download report
        function downloadReport(format, startDate = null, endDate = null, type = 'sales') {
            let url = `/api/download-report/?format=${format}&type=${type}`;
            
            if (startDate && endDate) {
                url += `&start_date=${startDate}&end_date=${endDate}`;
            } else {
                url += `&period=${currentPeriod}`;
            }
            
            const link = document.createElement('a');
            link.href = url;
            link.click();
        }
        
        // Start auto refresh
        function startAutoRefresh() {
            setInterval(() => {
                if (isAutoRefresh && document.visibilityState === 'visible') {
                    loadAnalyticsData();
                }
            }, refreshInterval);
        }
        
        // Show loading indicator
        function showLoading() {
            const loading = document.createElement('div');
            loading.id = 'analytics-loading';
            loading.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50';
            loading.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-lg flex items-center space-x-3">
                    <div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm font-medium text-gray-700">Yuklanmoqda...</span>
                </div>
            `;
            document.body.appendChild(loading);
        }
        
        // Hide loading indicator
        function hideLoading() {
            const loading = document.getElementById('analytics-loading');
            if (loading) {
                loading.remove();
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 left-4 right-4 p-4 rounded-lg shadow-lg z-50 slide-in
                ${type === 'success' ? 'bg-green-500 text-white' :
                  type === 'info' ? 'bg-blue-500 text-white' :
                  type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-500 text-white'}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="ri-${type === 'success' ? 'check' : type === 'info' ? 'information' : type === 'error' ? 'error-warning' : 'notification'}-line"></i>
                        <span class="text-sm font-medium">${message}</span>
                    </div>
                    <button class="close-notification">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Close button
            notification.querySelector('.close-notification').addEventListener('click', function() {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            });
            
            // Auto remove
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }
    </script>
</body>
</html>